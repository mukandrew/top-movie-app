package com.topmovies.data

import android.content.Context
import androidx.room.Room
import androidx.test.core.app.ApplicationProvider
import androidx.test.ext.junit.runners.AndroidJUnit4
import com.google.gson.Gson
import com.google.gson.reflect.TypeToken
import com.topmovies.data.entity.MovieEntity
import com.topmovies.data.local.AppDataBase
import com.topmovies.data.local.MovieDao
import kotlinx.coroutines.runBlocking
import org.hamcrest.core.IsEqual.equalTo
import org.junit.After
import org.junit.Assert.assertThat
import org.junit.Before
import org.junit.FixMethodOrder
import org.junit.Test
import org.junit.runner.RunWith
import org.junit.runners.MethodSorters
import java.io.IOException

@FixMethodOrder(MethodSorters.NAME_ASCENDING)
@RunWith(AndroidJUnit4::class)
class MovieEntityTest {

    private val MOVIE_ID = "301528"
    private val JSON_MOVIE_DETAIL = "{\"adult\":false,\"backdropPath\":\"/m67smI1IIMmYzCl9axvKNULVKLr.jpg\",\"belongs_to_collection\":{\"id\":10194,\"name\":\"Toy Story Collection\",\"poster_path\":\"/7G9915LfUQ2lVfwMEEhDsn3kT4B.jpg\",\"backdropPath\":\"/9FBwqcd9IRruEDUrTdcaafOMKUq.jpg\"},\"budget\":175000000,\"genres\":[{\"id\":12,\"name\":\"Adventure\"},{\"id\":16,\"name\":\"Animation\"},{\"id\":35,\"name\":\"Comedy\"},{\"id\":10751,\"name\":\"Family\"}],\"homepage\":null,\"id\":301528,\"imdb_id\":\"tt1979376\",\"original_language\":\"en\",\"original_title\":\"Toy Story 4\",\"overview\":\"Woody has always been confident about his place in the world and that his priority is taking care of his kid, whether that's Andy or Bonnie. But when Bonnie adds a reluctant new toy called \\\"Forky\\\" to her room, a road trip adventure alongside old and new friends will show Woody how big the world can be for a toy.\",\"popularity\":241.812,\"poster_path\":\"/w9kR8qbmQ01HwnvK4alvnQ2ca0L.jpg\",\"production_companies\":[{\"id\":2,\"logo_path\":\"/wdrCwmRnLFJhEoH8GSfymY85KHT.png\",\"name\":\"Walt Disney Pictures\",\"origin_country\":\"US\"},{\"id\":3,\"logo_path\":\"/1TjvGVDMYsj6JBxOAkUHpPEwLf7.png\",\"name\":\"Pixar\",\"origin_country\":\"US\"}],\"production_countries\":[{\"iso_3166_1\":\"US\",\"name\":\"United States of America\"}],\"release_date\":\"2019-06-19\",\"revenue\":509600000,\"runtime\":100,\"spoken_languages\":[{\"iso_639_1\":\"en\",\"name\":\"English\"}],\"status\":\"Released\",\"tagline\":\"\",\"title\":\"Toy Story 4\",\"video\":false,\"vote_average\":7.8,\"vote_count\":886}"
    private val JSON_MOVIE_LIST = "[{\"vote_count\":271,\"id\":429617,\"video\":false,\"vote_average\":7.7,\"title\":\"Homem-Aranha: Longe de Casa\",\"popularity\":442.543,\"poster_path\":\"\\/6wtOOCzTNxzwzwvpMeimMHQNTqI.jpg\",\"original_language\":\"en\",\"original_title\":\"Spider-Man: Far from Home\",\"genre_ids\":[28,12,878],\"backdropPath\":\"\\/dihW2yTsvQlust7mSuAqJDtqW7k.jpg\",\"adult\":false,\"overview\":\"Peter Parker está de volta em Homem-Aranha: Longe de Casa, novo capítulo da série De Volta Ao Lar. Nosso amigão da vizinhança decide se unir aos seus melhores amigos para passar férias na Europa. Mas o plano de Peter de abandonar seus feitos heroicos por algumas semanas logo são mudados quando ele concorda em ajudar Nick Fury a solucionar o mistério de ataques de criaturas elementais, criando uma destruição pelo continente...\",\"release_date\":\"2019-06-28\"},{\"vote_count\":892,\"id\":301528,\"video\":false,\"vote_average\":7.8,\"title\":\"Toy Story 4\",\"popularity\":241.812,\"poster_path\":\"\\/gUpO1uHeq16fDx47waCggANIKGR.jpg\",\"original_language\":\"en\",\"original_title\":\"Toy Story 4\",\"genre_ids\":[12,16,35,10751],\"backdropPath\":\"\\/m67smI1IIMmYzCl9axvKNULVKLr.jpg\",\"adult\":false,\"overview\":\"Woody, Buzz, Jesse e toda a turma vivem felizes, agora como brinquedos da pequena Bonnie. Entretanto, a chegada de um garfo transformado em brinquedo, Forky, faz com que a calmaria reinante chegue ao fim, justamente porque ele não se aceita como brinquedo.\",\"release_date\":\"2019-06-19\"},{\"vote_count\":2139,\"id\":287947,\"video\":false,\"vote_average\":7.1,\"title\":\"Shazam!\",\"popularity\":183.898,\"poster_path\":\"\\/wuicV3wiHje0Np1tb2AetTJLB9I.jpg\",\"original_language\":\"en\",\"original_title\":\"Shazam!\",\"genre_ids\":[28,35,14],\"backdropPath\":\"\\/bi4jh0Kt0uuZGsGJoUUfqmbrjQg.jpg\",\"adult\":false,\"overview\":\"Billy Batson (Asher Angel) tem apenas 14 anos de idade, mas recebeu de um antigo mago o dom de se transformar num super-herói adulto chamado Shazam (Zachary Levi). Ao gritar a palavra SHAZAM!, o adolescente se transforma nessa sua poderosa versão adulta para se divertir e testar suas habilidades. Contudo, ele precisa aprender a controlar seus poderes para enfrentar o malvado Dr. Thaddeus Sivana (Mark Strong).\",\"release_date\":\"2019-03-23\"},{\"vote_count\":200,\"id\":486131,\"video\":false,\"vote_average\":6.2,\"title\":\"Shaft\",\"popularity\":154.879,\"poster_path\":\"\\/kfZqwGuvEBAysAbCsa0QLKoSYR.jpg\",\"original_language\":\"en\",\"original_title\":\"Shaft\",\"genre_ids\":[28,80,35],\"backdropPath\":\"\\/103d4ObBCWbB6PtOOjZ7C1FSpVl.jpg\",\"adult\":false,\"overview\":\"John Shaft Jr., um especialista em segurança cibernética com diploma do MIT, pede a ajuda de sua família para descobrir a verdade por trás da morte prematura de seu melhor amigo.\",\"release_date\":\"2019-06-14\"},{\"vote_count\":1074,\"id\":320288,\"video\":false,\"vote_average\":6.3,\"title\":\"X-Men: Fênix Negra\",\"popularity\":147.75,\"poster_path\":\"\\/sKacZh7L9qR5jLpSnxgxung6D4Y.jpg\",\"original_language\":\"en\",\"original_title\":\"Dark Phoenix\",\"genre_ids\":[878,28],\"backdropPath\":\"\\/phxiKFDvPeQj4AbkvJLmuZEieDU.jpg\",\"adult\":false,\"overview\":\"Ambientado em 1992, Charles Xavier (James McAvoy) está lidando com o fato dos mutantes serem considerados heróis nacionais. Com o orgulho a flor da pele, ele envia sua equipe para perigosas missões, mas a primeira tarefa dos X-Men no espaço gera uma explosão solar, que acende uma força malévola e faminta por poder dentro de Jean Grey (Sophie Turner).\",\"release_date\":\"2019-06-05\"},{\"vote_count\":2225,\"id\":399579,\"video\":false,\"vote_average\":6.7,\"title\":\"Alita: Anjo de Combate\",\"popularity\":132.827,\"poster_path\":\"\\/IRCVlGKsuOsYRfPPb3jS9IC7Gi.jpg\",\"original_language\":\"en\",\"original_title\":\"Alita: Battle Angel\",\"genre_ids\":[28,878,53,12],\"backdropPath\":\"\\/aQXTw3wIWuFMy0beXRiZ1xVKtcf.jpg\",\"adult\":false,\"overview\":\"Uma ciborgue é descoberta por um cientista. Ela não tem memórias de sua criação, mas possui grande conhecimento de artes marciais. Enquanto busca informações sobre seu passado, trabalha como caçadora de recompensas e descobre um interesse amoroso.\",\"release_date\":\"2019-01-31\"},{\"vote_count\":869,\"id\":157433,\"video\":false,\"vote_average\":5.8,\"title\":\"Cemitério Maldito\",\"popularity\":120.595,\"poster_path\":\"\\/F66gh3HxLLHIsaxvH1zJSgPAsf.jpg\",\"original_language\":\"en\",\"original_title\":\"Pet Sematary\",\"genre_ids\":[53,9648,27],\"backdropPath\":\"\\/n2aX63BmW7zIKgKJ58e6rKlSsdi.jpg\",\"adult\":false,\"overview\":\"Dr. Louis Creed (Jason Clarke), que após se mudar com sua esposa Rachel (Amy Seimetz) e seus dois filhos, de Boston para o Maine, descobre um misterioso cemitério escondido nas florestas perto da nova casa da família. Quando uma tragédia os atinge, Louis se volta para seu vizinho incomum, Jud Crandall (John Lithgow), desencadeando uma perigosa reação em cadeia que libera um mal insondável com consequências terríveis.\",\"release_date\":\"2019-04-04\"},{\"vote_count\":16,\"id\":566555,\"video\":false,\"vote_average\":4.8,\"title\":\"名探偵コナン 紺青の拳（フィスト）\",\"popularity\":118.171,\"poster_path\":\"\\/86Y6qM8zTn3PFVfCm9J98Ph7JEB.jpg\",\"original_language\":\"ja\",\"original_title\":\"名探偵コナン 紺青の拳（フィスト）\",\"genre_ids\":[16,28,18,9648,35],\"backdropPath\":\"\\/wf6VDSi4aFCZfuD8sX8JAKLfJ5m.jpg\",\"adult\":false,\"overview\":\"\",\"release_date\":\"2019-04-12\"},{\"vote_count\":116,\"id\":521029,\"video\":false,\"vote_average\":6.4,\"title\":\"Annabelle 3: De Volta Para Casa\",\"popularity\":117.729,\"poster_path\":\"\\/m8h2gz4El6bvYpDjyQhb7R49rSp.jpg\",\"original_language\":\"en\",\"original_title\":\"Annabelle Comes Home\",\"genre_ids\":[27],\"backdropPath\":\"\\/dBt0DoFfbhOI4ypUfRj1uTq623M.jpg\",\"adult\":false,\"overview\":\"Quando Ed (Patrick Wilson) e Lorraine Warren (Vera Farmiga) deixam sua casa durante um fim de semana, a filha do casal, a pequena Judy Warren (McKenna Grace), é deixada aos cuidados de sua babá (Madison Iseman). Mas as duas entram em perigo quando a maligna boneca Annabelle, aproveitando que os investigadores paranormais estão fora de jogo, anima os letais e aterrorizantes objetos contidos na Sala dos Artefatos dos Warren.\",\"release_date\":\"2019-06-26\"},{\"vote_count\":6076,\"id\":299537,\"video\":false,\"vote_average\":7,\"title\":\"Capitã Marvel\",\"popularity\":104.699,\"poster_path\":\"\\/hVgLHgnsO46oSHJy5I4ekhqtoYv.jpg\",\"original_language\":\"en\",\"original_title\":\"Captain Marvel\",\"genre_ids\":[28,12,878],\"backdropPath\":\"\\/w2PMyoyLU22YvrGK3smVM9fW1jj.jpg\",\"adult\":false,\"overview\":\"A história segue Carol Danvers e como ela se torna um dos heróis mais poderosos do universo quando a Terra é pega no meio de uma guerra galáctica entre duas raças alienígenas. Situado na década de 1990, Capitã Marvel é uma nova aventura de um período inédito na história do universo cinematográfico da Marvel.\",\"release_date\":\"2019-03-06\"},{\"vote_count\":14216,\"id\":299536,\"video\":false,\"vote_average\":8.3,\"title\":\"Vingadores: Guerra Infinita\",\"popularity\":98.757,\"poster_path\":\"\\/rkHe0BfOo1f5N2q6rxgdYac7Zf6.jpg\",\"original_language\":\"en\",\"original_title\":\"Avengers: Infinity War\",\"genre_ids\":[12,28,14],\"backdropPath\":\"\\/bOGkgRGdhrBYJSLpXaxhXVstddV.jpg\",\"adult\":false,\"overview\":\"Enquanto os Vingadores e seus aliados continuaram a proteger o mundo de ameaças grandes demais para qualquer herói, uma nova ameaça emergiu das sombras cósmicas: Thanos. Um déspota de infâmia intergalática, tem o objetivo de coletar todas as seis Joias do Infinito, artefatos de poder inimaginável, e usá-las para infligir sua vontade distorcida em toda a realidade. Tudo pelo que os Vingadores lutaram levou até este momento - o destino da Terra e da própria existência nunca foi tão incerto.\",\"release_date\":\"2018-04-25\"},{\"vote_count\":7655,\"id\":920,\"video\":false,\"vote_average\":6.7,\"title\":\"Carros\",\"popularity\":94.812,\"poster_path\":\"\\/2nM2NRV8wt3n3ffoHQ3KdMkY3vR.jpg\",\"original_language\":\"en\",\"original_title\":\"Cars\",\"genre_ids\":[16,12,35,10751],\"backdropPath\":\"\\/a1MlbLBk5Sy6YvMbSuKfwGlDVlb.jpg\",\"adult\":false,\"overview\":\"Sensação da temporada da Copa do Pistão, o estreante Relâmpago McQueen aproveita a fama e as glórias de suas vitórias. Até o dia em que, no caminho para a corrida mais importante de sua vida, perde-se no meio da estrada. Em Radiator Springs, uma esquecida cidadezinha da velha Rota 66, que o ajudam a descobrir que há coisas mais importantes na vida do que troféus e fama. Com uma trilha sonora sensacional e bônus alucinantes, incluindo um exclusivo curta animado Mate e a Luz Fantasma, Carros é garantia de diversão a toda velocidade.\",\"release_date\":\"2006-06-08\"},{\"vote_count\":1326,\"id\":458156,\"video\":false,\"vote_average\":7.1,\"title\":\"John Wick 3 - Parabellum\",\"popularity\":94.179,\"poster_path\":\"\\/eDIxIvpBm5MsHuafEEmCQIKfG4u.jpg\",\"original_language\":\"en\",\"original_title\":\"John Wick: Chapter 3 – Parabellum\",\"genre_ids\":[80,28,53],\"backdropPath\":\"\\/vVpEOvdxVBP2aV166j5Xlvb5Cdc.jpg\",\"adult\":false,\"overview\":\"Após assassinar o chefe da máfia Santino D'Antonio (Riccardo Scamarcio) no Hotel Continental, John Wick (Keanu Reeves) passa a ser perseguido pelos membros da Alta Cúpula sob a recompensa de U\$14 milhões. Agora, ele precisa unir forças com antigos parceiros que o ajudaram no passado enquanto luta por sua sobrevivência. by xilften.net\",\"release_date\":\"2019-05-15\"},{\"vote_count\":2012,\"id\":420817,\"video\":false,\"vote_average\":7.2,\"title\":\"Aladdin\",\"popularity\":91.37,\"poster_path\":\"\\/cYlzLYlhUXS0kW9T3ttAQ6fvZuV.jpg\",\"original_language\":\"en\",\"original_title\":\"Aladdin\",\"genre_ids\":[12,14,10749,35,10751],\"backdropPath\":\"\\/v4yVTbbl8dE1UP2dWu5CLyaXOku.jpg\",\"adult\":false,\"overview\":\"Um jovem humilde descobre uma lâmpada mágica, com um gênio que pode lhe conceder desejos. Agora o rapaz quer conquistar a moça por quem se apaixonou, mas o que ele não sabe é que a jovem é uma princesa que está prestes a se noivar. Agora, com a ajuda do Gênio (Will Smith), ele tenta se passar por um príncipe e para conquistar o amor da moça e a confiança de seu pai.\",\"release_date\":\"2019-05-22\"},{\"vote_count\":7395,\"id\":299534,\"video\":false,\"vote_average\":8.4,\"title\":\"Vingadores: Ultimato\",\"popularity\":86.811,\"poster_path\":\"\\/q6725aR8Zs4IwGMXzZT8aC8lh41.jpg\",\"original_language\":\"en\",\"original_title\":\"Avengers: Endgame\",\"genre_ids\":[12,878,28],\"backdropPath\":\"\\/7RyHsO4yDXtBv1zUU3mTpHeQ0d5.jpg\",\"adult\":false,\"overview\":\"Após os eventos devastadores de Vingadores: Guerra Infinita, o universo está em ruínas devido aos esforços do Titã Louco, Thanos. Com a ajuda de aliados remanescentes, os Vingadores devem se reunir mais uma vez a fim de desfazer as ações de Thanos e restaurar a ordem no universo de uma vez por todas, não importando as consequências.\",\"release_date\":\"2019-04-24\"},{\"vote_count\":29,\"id\":532321,\"video\":false,\"vote_average\":5.5,\"title\":\"Re:Zero kara Hajimeru Isekai Seikatsu - Memory Snow\",\"popularity\":84.892,\"poster_path\":\"\\/xqR4ABkFTFYe8NDJi3knwWX7zfn.jpg\",\"original_language\":\"ja\",\"original_title\":\"Re:ゼロから始める異世界生活 Memory Snow\",\"genre_ids\":[16,12],\"backdropPath\":\"\\/8sNz2DxYiYqGkxk66U8BqvuZZjE.jpg\",\"adult\":false,\"overview\":\"Subaru e amigos finalmente conseguem um momento de paz, e Subaru parte em uma certa missão secreta que ele não deve deixar ninguém descobrir! No entanto, apesar de Subaru estar usando um disfarce, Petra e outras crianças da vila imediatamente descobrem quem ele é. Agora que sua missão foi exposta dentro de cinco segundos de partida, o que acontecerá com o \\\"curso de data\\\" de Subaru com Emilia?\",\"release_date\":\"2018-10-06\"},{\"vote_count\":1257,\"id\":537915,\"video\":false,\"vote_average\":5.8,\"title\":\"After\",\"popularity\":81.484,\"poster_path\":\"\\/u3B2YKUjWABcxXZ6Nm9h10hLUbh.jpg\",\"original_language\":\"en\",\"original_title\":\"After\",\"genre_ids\":[18,10749],\"backdropPath\":\"\\/997ToEZvF2Obp9zNZbY5ELVnmrW.jpg\",\"adult\":false,\"overview\":\"Baseado no romance de Anna Todd, o filme retrata a jornada de Tessa Young (Josephine Langford), uma jovem de 18 anos com uma vida simples: ótimas notas na escola, muitos amigos e um namorado doce. Todos os próximos passos de sua vida já estão planejados, mas as coisas desandam quando ela conhece um homem rebelde e rude com segredos sombrios que mudam sua vida.\",\"release_date\":\"2019-04-11\"},{\"vote_count\":1449,\"id\":329996,\"video\":false,\"vote_average\":6.5,\"title\":\"Dumbo\",\"popularity\":71.984,\"poster_path\":\"\\/c8Krn1Fb8h3DsCgGMxmS1zmMN1n.jpg\",\"original_language\":\"en\",\"original_title\":\"Dumbo\",\"genre_ids\":[12,10751,14],\"backdropPath\":\"\\/5tFt6iuGnKapHl5tw0X0cKcnuVo.jpg\",\"adult\":false,\"overview\":\"1919, Joplin, Estados Unidos. Holt Farrier (Colin Farrell) é uma ex-estrela de circo que retorna da guerra e encontra seu mundo virado de cabeça para baixo. O circo em que trabalhava está passando por grandes dificuldades, e ele fica encarregado de cuidar de um elefante recém-nascido, cujas orelhas gigantes fazem dele motivo de piada. No entanto, seus filhos Milly (Nico Parker) e Joe (Finley Hobbins) descobrem que o pequeno elefante é capaz de uma façanha enorme.\",\"release_date\":\"2019-03-27\"},{\"vote_count\":43,\"id\":480042,\"video\":false,\"vote_average\":4.8,\"title\":\"Rota de Fuga 3\",\"popularity\":71.627,\"poster_path\":\"\\/9V5fl1mGgVZzOYod0Jq2hyRlzEY.jpg\",\"original_language\":\"en\",\"original_title\":\"Escape Plan: The Extractors\",\"genre_ids\":[28,53],\"backdropPath\":\"\\/ygWKYTu7OnZKF9H5NsgjL9iURGV.jpg\",\"adult\":false,\"overview\":\"Terceira parte da franquia Rota de Fuga. Aqui a história retorna quando Breslin e DeRosa unem suas forças para resgatar um dos membros de seu time, mantido em cativeiro na penitenciária Devil’s Station. A sinopse oficial ainda não foi divulgada.\",\"release_date\":\"2019-06-20\"},{\"vote_count\":395,\"id\":479455,\"video\":false,\"vote_average\":6.1,\"title\":\"MIB: Homens de Preto - Internacional\",\"popularity\":68.505,\"poster_path\":\"\\/juOUt2CgRwlcweTNaT1NJeTZEyj.jpg\",\"original_language\":\"en\",\"original_title\":\"Men in Black: International\",\"genre_ids\":[28,35,878,12],\"backdropPath\":\"\\/2FYzxgLNuNVwncilzUeCGbOQzP7.jpg\",\"adult\":false,\"overview\":\"Por décadas a agência Homens de Preto protegeu a Terra da escória do universo, mas agora precisa lidar com a maior das ameaças: um traidor, justo quando a agência torna-se internacional. É neste contexto que Em (Tessa Thompson) tenta se tornar agente, já que teve uma experiência extraterrestre quando jovem e não teve sua memória apagada. Quem irá auxiliá-la nesta jornada é o atrapalhado agente H (Chris Hemsworth).\",\"release_date\":\"2019-06-12\"}]"

    private val LIST_MOVIE_DATA: List<MovieEntity> by lazy {
        Gson().fromJson<List<MovieEntity>>(
            JSON_MOVIE_LIST,
            object : TypeToken<List<MovieEntity>>() {}.type
        )
    }

    private val MOVIE_DETAIL_DATA: MovieEntity by lazy {
        Gson().fromJson<MovieEntity>(JSON_MOVIE_DETAIL, object : TypeToken<MovieEntity>() {}.type)
    }

    private lateinit var movieDao: MovieDao
    private lateinit var appDataBase: AppDataBase

    private lateinit var context: Context

    @Before
    fun before() {
        context = ApplicationProvider.getApplicationContext<Context>()

        appDataBase = Room.inMemoryDatabaseBuilder(context, AppDataBase::class.java).build()
        movieDao = appDataBase.movieDao()
    }

    @After
    @Throws(IOException::class)
    fun closeDb() {
        appDataBase.close()
    }

    @Test
    fun ioDB() = runBlocking {
        movieDao.insert(MOVIE_DETAIL_DATA)
        val movie = movieDao.find(MOVIE_ID)
        assertThat(movie.id, equalTo(MOVIE_DETAIL_DATA.id))

        movieDao.removeAll()

        movieDao.insertList(LIST_MOVIE_DATA)
        val listOne = movieDao.list()
        for ((i, movie) in listOne.withIndex()) {
            assertThat(movie.id, equalTo(LIST_MOVIE_DATA[i].id))
        }

        movieDao.removeAll()

        val listTwo = movieDao.list()
        assertThat(listTwo, equalTo(emptyList()))
    }

}